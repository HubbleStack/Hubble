
def imgname = 'hubblestack/jenkins:centos-v1.0.15'

pipeline {
    agent {
        docker {
            image "${imgname}"
        }
    }

    options {
        timestamps()
        ansiColor 'xterm'
        buildDiscarder(logRotator(numToKeepStr: '2', artifactNumToKeepStr: '1'))
    }

    environment {
        PY_COLORS = 1
        HS_PROFILE = 1
        TEST_PY_V = '3.6.10'
        OUTPUT = 'tests/unittests/output'
        REF = 'tests/unittests/output/relevant-files.txt'
        SKIP_0_POOL_NTP_TEST = 1
    }

    stages {
        stage('setup') {
            steps {
                sh '''#!/bin/bash
                    echo "---=: CLEAN UP WORKSPACE :=---"
                    git clean -dfx -e .pip-cache
                    mkdir -vp $OUTPUT
                    '''

                sh '''#!/bin/bash
                    echo "---=: RELEVANT-FILES.TXT :=---"
                    if [ -z "$CHANGE_TARGET" ]; then
                        git log --decorate --pretty=%H%d --simplify-by-decoration > git-log.txt
                        tail -n +2 git-log.txt | head -n 1 > nearest-ancestor.txt
                        echo "nearest ancestor seems to be $(<nearest-ancestor.txt)"
                        CHANGE_TARGET=$(cut -d' ' -f1 < nearest-ancestor.txt)
                        echo "set CHANGE_TARGET=\"$CHANGE_TARGET\" (becuase it was empty)"
                    fi

                    if [ -z "$BRANCH_NAME" ]; then
                        echo "setting BRANCH_NAME=HEAD (because it was empty)"
                        BRANCH_NAME=HEAD
                    fi

                    if tmp=$(git rev-parse origin/$CHANGE_TARGET)
                    then LHS=$tmp
                    else LHS=$CHANGE_TARGET
                    fi
                    echo "computed git diff LHS: $RHS"

                    if tmp=$(git rev-parse origin/$BRANCH_NAME)
                    then RHS=$tmp
                    else RHS=$BRANCH_NAME
                    fi
                    echo "computed git diff RHS: $RHS"

                    if [ -n "$LHS" -a -n "$RHS" ]
                    then find hubblestack -name "*.py" -print0 \\
                        | xargs -r0 git diff --name-only "$LHS" "$RHS" > $REF
                        head -v $REF
                    else cat /dev/null > $REF
                         echo "*** NULL $REF ***"
                    fi
                '''

                sh '''#!/bin/bash
                    echo "---=: CONFIGURE TEST ENVIRONMENT :=---"
                    source /etc/profile.d/kersplat.sh
                    export PY_V="$TEST_PY_V"
                    pyenv local $TEST_PY_V
                    pyenv shell $TEST_PY_V
                    echo "pyenv version-name: $(pyenv version-name)"
                    pip install --upgrade --cache-dir .pip-cache -t ./vlib virtualenv
                    PYTHONPATH=./vlib ./vlib/bin/virtualenv ./venv --system-site-packages
                    source ./venv/bin/activate
                    pip install --upgrade --cache-dir .pip-cache -U pip
                    echo no | ./mk-requires.sh
                    pip install --upgrade --cache-dir .pip-cache -U -r requirements.txt
                    '''
            }
        }
        stage('lint/test') {
            parallel {
                stage('pytest') {
                    steps {
                        sh '''#!/bin/bash
                            source ./venv/bin/activate
                            pytest tests/unittests --html=tests/unittests/output/pytest.html
                            x=$?
                            cp tests/unittests/output/combined.svg tests/unittests/output/profile-diagram.svg
                            exit $x
                            '''
                    }
                }
                stage('pylint') {
                    steps {
                        sh '''#!/bin/bash
                            source ./venv/bin/activate
                            if [ -s $REF ]
                            then xargs -r pylint --output-format=json < $REF > $OUTPUT/pylint.json; x=$?
                                 echo "Wrote $(wc -l < $OUTPUT/pylint.json) line(s) to $OUTPUT/pylint.json with exit($x)"
                            else echo SKIPPING PYLINT "$REF is empty"; x=0
                            fi
                            test -s $OUTPUT/pylint.json || echo '[]' > $OUTPUT/pylint.json
                            python ./tests/automation/pylint-json-to-html $OUTPUT/pylint.json
                            echo "Wrote $(wc -l < $OUTPUT/pylint.html) line(s) to $OUTPUT/pylint.html (see test reports)"
                            exit $x
                            '''
                    }
                }
            }
        }
    }

    post {
        always {
            publishHTML (target: [
                allowMissing: false,
                alwaysLinkToLastBuild: false,
                keepAll: true,
                reportDir: 'tests/unittests/output',
                reportFiles: 'pytest.html, coverage/index.html, pylint.html, profile-diagram.svg, relevant-files.txt',
                reportName: "Test Reports"
            ])
        }
    }
}
